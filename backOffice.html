<script async defer src="https://accounts.google.com/gsi/client" onload="initGoogleAuth()"></script>
<script src="config.js"></script> <!-- Import config.js first -->

<script>
    let accessToken = "";

    // Initialize Google OAuth Client
    function initGoogleAuth() {
        google.accounts.oauth2.initTokenClient({
            client_id: CONFIG.CLIENT_ID,
            scope: "https://www.googleapis.com/auth/analytics.readonly", // Required scope for analytics data
            callback: (tokenResponse) => {
                accessToken = tokenResponse.access_token; // Store the access token
                console.log("Google Auth Success!");
                getAnalyticsReport(); // Fetch Analytics data after authentication
            }
        }).requestAccessToken();
    }

    // Get Analytics Report
    function getAnalyticsReport() {
        fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${CONFIG.PROPERTY_ID}:runReport`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                dateRanges: [
                    {
                        startDate: "7daysAgo",
                        endDate: "today"
                    }
                ],
                metrics: [
                    {
                        name: "activeUsers" // Metric for active users
                    }
                ],
                dimensions: [
                    {
                        name: "date" // Optional: Add dimension like date for daily data
                    }
                ]
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("Analytics Data:", data); // Log the data for debugging
            let activeUsers = data.rows[0].metricValues[0].value;
            document.getElementById("user-count").innerText = `Active Users: ${activeUsers}`; // Display result
        })
        .catch(error => console.error("Error fetching data from API:", error));
    }
</script>

<!-- HTML to trigger the authentication and display the result -->
<button onclick="initGoogleAuth()">Connect with Google</button>
<p id="user-count">Loading...</p>
